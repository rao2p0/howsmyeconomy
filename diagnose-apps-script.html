<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Apps Script Diagnostics</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 8px; font-size: 14px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .code { background: #f1f3f4; padding: 8px; border-radius: 4px; font-family: monospace; }
        input { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #ddd; border-radius: 4px; }
        .step { margin: 15px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üîß Google Apps Script Diagnostics</h1>
    <p>This tool will help diagnose and fix POST request issues with your Google Apps Script.</p>

    <div class="section info">
        <h2>üìã Current Configuration</h2>
        <p><strong>Deployment URL:</strong></p>
        <input type="url" id="deploymentUrl" value="https://script.google.com/macros/s/AKfycbwyZMwUO_TxBJd0duCo_cPXgigTYuHgkCTs_ipTOh7WxUhDUFGNgrLn6Oj2Qnk5DOdwog/exec">
        <button onclick="runFullDiagnostic()">üöÄ Run Full Diagnostic</button>
    </div>

    <div id="diagnosticResults"></div>

    <div class="section warning">
        <h2>üõ†Ô∏è Troubleshooting Steps</h2>
        <div class="step">
            <h3>Step 1: Verify Script Content</h3>
            <p>Make sure your Google Apps Script contains both functions:</p>
            <pre><code>function doGet(e) {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Google Apps Script is working!'
  })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    // Your email processing logic here
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Email successfully processed'
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}</code></pre>
        </div>

        <div class="step">
            <h3>Step 2: Check Deployment Settings</h3>
            <p>When deploying, ensure:</p>
            <ul>
                <li><strong>Type:</strong> Web app</li>
                <li><strong>Execute as:</strong> Me (your email)</li>
                <li><strong>Who has access:</strong> Anyone</li>
            </ul>
        </div>

        <div class="step">
            <h3>Step 3: Test Direct POST</h3>
            <button onclick="testDirectPost()">üìÆ Test Direct POST</button>
            <div id="directPostResult"></div>
        </div>

        <div class="step">
            <h3>Step 4: Generate Fixed Script</h3>
            <button onclick="generateFixedScript()">üìù Generate Corrected Script</button>
            <div id="fixedScriptOutput"></div>
        </div>
    </div>

    <script>
        async function runFullDiagnostic() {
            const url = document.getElementById('deploymentUrl').value;
            const resultsDiv = document.getElementById('diagnosticResults');
            
            let diagnosticHtml = '<h2>üîç Diagnostic Results</h2>';
            
            // Test 1: Basic connectivity
            diagnosticHtml += '<h3>Test 1: Basic Connectivity</h3>';
            try {
                const response = await fetch(url, { method: 'GET' });
                const data = await response.json();
                diagnosticHtml += `<div class="section success">‚úÖ GET Request: WORKING<br>Status: ${response.status}<br>Response: ${JSON.stringify(data)}</div>`;
            } catch (error) {
                diagnosticHtml += `<div class="section error">‚ùå GET Request: FAILED<br>Error: ${error.message}</div>`;
            }
            
            // Test 2: CORS headers
            diagnosticHtml += '<h3>Test 2: CORS Headers</h3>';
            try {
                const response = await fetch(url, { 
                    method: 'OPTIONS',
                    headers: { 'Content-Type': 'application/json' }
                });
                diagnosticHtml += `<div class="section success">‚úÖ CORS: WORKING<br>Status: ${response.status}</div>`;
            } catch (error) {
                diagnosticHtml += `<div class="section warning">‚ö†Ô∏è CORS: May have issues<br>Error: ${error.message}</div>`;
            }
            
            // Test 3: Simple POST
            diagnosticHtml += '<h3>Test 3: POST Request</h3>';
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: 'diagnostic' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    diagnosticHtml += `<div class="section success">‚úÖ POST Request: WORKING<br>Status: ${response.status}<br>Response: ${JSON.stringify(data)}</div>`;
                } else {
                    const errorText = await response.text();
                    diagnosticHtml += `<div class="section error">‚ùå POST Request: FAILED<br>Status: ${response.status}<br>Error: ${errorText}</div>`;
                }
            } catch (error) {
                diagnosticHtml += `<div class="section error">‚ùå POST Request: FAILED<br>Error: ${error.message}<br><strong>This indicates the doPost function is missing or deployment is incorrect!</strong></div>`;
            }
            
            resultsDiv.innerHTML = diagnosticHtml;
        }
        
        async function testDirectPost() {
            const url = document.getElementById('deploymentUrl').value;
            const resultDiv = document.getElementById('directPostResult');
            
            const testData = {
                email: 'test@diagnostic.com',
                source: 'Diagnostic Tool',
                timestamp: new Date().toISOString()
            };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const responseText = await response.text();
                
                resultDiv.innerHTML = `
                    <div class="section ${response.ok ? 'success' : 'error'}">
                        <strong>Direct POST Test:</strong><br>
                        Status: ${response.status} ${response.statusText}<br>
                        Response: <pre>${responseText}</pre>
                        Sent: <pre>${JSON.stringify(testData, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="section error">
                        <strong>Direct POST Failed:</strong><br>
                        Error: ${error.message}<br>
                        This suggests a fundamental deployment issue.
                    </div>
                `;
            }
        }
        
        function generateFixedScript() {
            const outputDiv = document.getElementById('fixedScriptOutput');
            
            const correctedScript = `// CORRECTED Google Apps Script for Email Collection
// Copy this ENTIRE script to your Google Apps Script project

const SPREADSHEET_ID = '1c2ixD-oniWWWocj14kcagV6Ok5mXxzXv-NMIZr165l4';

function doGet(e) {
  const output = ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Google Apps Script is working!',
    timestamp: new Date().toISOString(),
    spreadsheetId: SPREADSHEET_ID,
    hasDoPost: typeof doPost === 'function'
  }));
  
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function doPost(e) {
  try {
    console.log('doPost called with:', e.postData.contents);
    
    const data = JSON.parse(e.postData.contents);
    console.log('Parsed data:', data);
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getActiveSheet();
    
    // Add headers if first row
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'Timestamp', 'Email', 'Source', 'Frequency', 
        'Page URL', 'User Agent', 'Name', 'Message', 'Feedback Type'
      ]);
    }
    
    // Add the data
    sheet.appendRow([
      new Date().toISOString(),
      data.email || '',
      data.source || 'Unknown',
      data.frequency || 'Not specified',
      data.page || '',
      data.userAgent || '',
      data.name || '',
      data.message || '',
      data.feedbackType || ''
    ]);
    
    const output = ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Email successfully added to spreadsheet',
      rowsAdded: 1
    }));
    
    output.setMimeType(ContentService.MimeType.JSON);
    return output;
      
  } catch (error) {
    console.error('doPost error:', error);
    
    const output = ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.toString(),
      stack: error.stack
    }));
    
    output.setMimeType(ContentService.MimeType.JSON);
    return output;
  }
}`;
            
            outputDiv.innerHTML = `
                <div class="section info">
                    <h4>üìù Copy this corrected script to your Google Apps Script:</h4>
                    <pre><code>${correctedScript}</code></pre>
                    <p><strong>After copying:</strong></p>
                    <ol>
                        <li>Save the script</li>
                        <li>Click "Deploy" ‚Üí "New Deployment"</li>
                        <li>Set type to "Web app", execute as "Me", access "Anyone"</li>
                        <li>Copy the new URL and update your config</li>
                    </ol>
                </div>
            `;
        }
    </script>
</body>
</html> 